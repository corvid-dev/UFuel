{% extends "base.html" %}
{% block content %}
<<<<<<< HEAD
    <h1>Meal Library Test Page</h1>
    <p>
        <a href="/">Meal Generator →</a><br>
        <a href="/view-meals">View Meal Library →</a><br>
    </p>

=======
    <h1>Upload Meal Library Test Page</h1>
    <hr>
>>>>>>> main
    <h2>Upload CSV File</h2>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv" required>
        <button type="submit">Upload</button>
    </form>
    <p id="uploadStatus"></p>

    <hr>

    <h2>Add a Single Meal</h2>
    <form id="manualForm">
        <p>
            Name: <input type="text" name="name" required>
        </p>
        <p>
            Protein (g): <input type="number" step="1" id="protein" name="protein" required>
            Carbs (g): <input type="number" step="1" id="carbohydrates" name="carbohydrates" required>
            Fat (g): <input type="number" step="1" id="fat" name="fat" required>
        </p>
        <p>
            Calories: <span id="caloriesDisplay">0</span>
        </p>
        <p>
            Meal Type:
            <select name="meal_type" required>
                <option value="" disabled selected>--select--</option>
                <option value="breakfast">breakfast</option>
                <option value="lunch">lunch</option>
                <option value="dinner">dinner</option>
                <option value="drink">drink</option>
            </select>
        </p>
        <p>
            Location:
            <select name="location" required>
                <option value="" disabled selected>--select--</option>
                <option value="Glen">Glen</option>
                <option value="Newell">Newell</option>
                <option value="West Village">West Village</option>
            </select>
        </p>
        <button type="submit">Add Meal</button>
    </form>
    <p id="manualStatus"></p>

<<<<<<< HEAD
    <hr>
    <p><a href="/">← Back to main page</a></p>

=======
>>>>>>> main
    <script>
        // --- CSV Upload ---
        document.getElementById("uploadForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const res = await fetch("/upload-meal-library", { method: "POST", body: formData });
            const data = await res.json();
            document.getElementById("uploadStatus").textContent = data.message || data.error;
        });

        // --- Auto-calculate and display calories ---
        function updateCalories() {
            const protein = parseFloat(document.getElementById("protein").value) || 0;
            const carbs = parseFloat(document.getElementById("carbohydrates").value) || 0;
            const fat = parseFloat(document.getElementById("fat").value) || 0;
            const calories = (protein * 4) + (carbs * 4) + (fat * 9);
            document.getElementById("caloriesDisplay").textContent = calories.toFixed(1);
        }

        ["protein", "carbohydrates", "fat"].forEach(id => {
            document.getElementById(id).addEventListener("input", updateCalories);
        });

        // --- Manual Meal Entry ---
        document.getElementById("manualForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const jsonData = Object.fromEntries(formData.entries());

            // Calculate calories before sending to backend
            const protein = parseFloat(jsonData.protein) || 0;
            const carbs = parseFloat(jsonData.carbohydrates) || 0;
            const fat = parseFloat(jsonData.fat) || 0;
            jsonData.calories = (protein * 4) + (carbs * 4) + (fat * 9);

            const res = await fetch("/add-meal", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(jsonData)
            });
            const data = await res.json();
            document.getElementById("manualStatus").textContent = data.message || data.error;
        });
    </script>
{% endblock %}