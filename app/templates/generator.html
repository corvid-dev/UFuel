{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/generator.css', v='2') }}">
{% endblock %}

{% block content %}
<div class="generatorPage">
	<h1>UFuel Meal Generator</h1>

	<div class="generatorLayout">
		<form id="testForm" class="testForm">
			<p>Age: <input type="number" id="age" placeholder="Enter Your Age"></p>
			<p>Height (in): <input type="number" id="height" placeholder="Enter Your Height"></p>
			<p>Weight (lb): <input type="number" id="weight" placeholder="Enter Your Weight"></p>

			<p>
				Gender:
				<select id="gender">
					<option value="" disabled selected>--select--</option>
					<option value="male">Male</option>
					<option value="female">Female</option>
				</select>
			</p>

			<p>
				Activity Level:
				<select id="activity">
					<option value="" disabled selected>--select--</option>
					<option value="sedentary">Sedentary</option>
					<option value="moderate">Moderate</option>
					<option value="active">Active</option>
				</select>
			</p>

			<p>
				Goal:
				<select id="goal">
					<option value="" disabled selected>--select--</option>
					<option value="lose">Lose</option>
					<option value="maintain">Maintain</option>
					<option value="gain">Gain</option>
				</select>
			</p>

			<h3>Meal Locations</h3>

			<p>
				Breakfast Location:
				<select id="breakfast_location">
					<option value="" disabled selected>--select--</option>
					<option value="Glen">Glen</option>
					<option value="Newell">Newell</option>
					<option value="West Village">West Village</option>
				</select>
			</p>

			<p>
				Lunch Location:
				<select id="lunch_location">
					<option value="" disabled selected>--select--</option>
					<option value="Glen">Glen</option>
					<option value="Newell">Newell</option>
					<option value="West Village">West Village</option>
				</select>
			</p>

			<p>
				Dinner Location:
				<select id="dinner_location">
					<option value="" disabled selected>--select--</option>
					<option value="Glen">Glen</option>
					<option value="Newell">Newell</option>
					<option value="West Village">West Village</option>
				</select>
			</p>

			<button type="submit">Run</button>
		</form>

		<div class="resultsBox">
			<h3>Generated Meals:</h3>
			<table id="resultTable">
				<thead></thead>
				<tbody></tbody>
			</table>

			<pre id="output"></pre>
		</div>
	</div>
</div>

<script src="{{ url_for('static', filename='js/main.js') }}"></script>

<script>
	document.getElementById("testForm").addEventListener("submit", async function (event) {
		event.preventDefault();
		const age = document.getElementById("age").value;
		const height = document.getElementById("height").value;
		const weight = document.getElementById("weight").value;
		const gender = document.getElementById("gender").value;
		const activity = document.getElementById("activity").value;
		const goal = document.getElementById("goal").value;
		console.log("Form submitted without reload", { age, height, weight, gender, activity, goal });
	});

	function renderTable(data) {
		const table = document.getElementById('resultTable');
		const thead = table.querySelector('thead');
		const tbody = table.querySelector('tbody');
		thead.innerHTML = '';
		tbody.innerHTML = '';

		const plan = data.meal_plan?.plan;
		if (!plan) {
			tbody.innerHTML = '<tr><td>No meal plan found.</td></tr>';
			return;
		}

		const headers = ['Name', 'Calories', 'Protein', 'Carbs', 'Fat', 'Location'];
		thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';

		function addRow(item) {
			const row = document.createElement('tr');
			const safe = (v) => (v === undefined || v === null ? '' : v);
			row.innerHTML = `
        <td>${safe(item.name)}</td>
        <td>${safe(item.calories)}</td>
        <td>${safe(item.protein)}</td>
        <td>${safe(item.carbs)}</td>
        <td>${safe(item.fat)}</td>
        <td>${safe(item.location)}</td>
      `;
			tbody.appendChild(row);
		}

		let totals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
		function accumulate(item) {
			totals.calories += Number(item.calories || 0);
			totals.protein += Number(item.protein || 0);
			totals.carbs += Number(item.carbs || 0);
			totals.fat += Number(item.fat || 0);
		}


		['breakfast', 'lunch', 'dinner'].forEach(mealPeriod => {
			const mealData = plan[mealPeriod];
			if (!mealData) return;
			const headerRow = document.createElement('tr');
			headerRow.classList.add('section-header');
			headerRow.innerHTML = `<td colspan="${headers.length}">${mealPeriod.toUpperCase()}</td>`;
			tbody.appendChild(headerRow);

			if (mealData.drink) {
				addRow(mealData.drink);
				accumulate(mealData.drink);
			}
			if (Array.isArray(mealData.meals)) {
				mealData.meals.forEach(meal => {
					addRow(meal);
					accumulate(meal);
				});
			}

		});

		// Create totals row
		const totalRow = document.createElement('tr');
		totalRow.classList.add('total-row');
		totalRow.innerHTML = `
  <td><strong>DAILY TOTAL</strong></td>
  <td><strong>${totals.calories}</strong></td>
  <td><strong>${totals.protein}</strong></td>
  <td><strong>${totals.carbs}</strong></td>
  <td><strong>${totals.fat}</strong></td>
  <td></td>
`;
		tbody.appendChild(totalRow);

	}
</script>



<script>
	// Temporarily store the user's info
document.addEventListener("DOMContentLoaded", () => {
    const fields = [
        "age", "height", "weight",
        "gender", "activity", "goal",
        "breakfast_location", "lunch_location", "dinner_location"
    ];

    // Load saved values when page loads
    fields.forEach(id => {
        const stored = sessionStorage.getItem(id);
        if (stored !== null) {
            document.getElementById(id).value = stored;
        }
    });

    // Save every time user changes any field
    fields.forEach(id => {
        document.getElementById(id).addEventListener("change", (e) => {
            sessionStorage.setItem(id, e.target.value);
        });
    });
});
</script>




{% endblock %}